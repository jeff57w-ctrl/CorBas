<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CorBas - Complete Corpus Analysis Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        .status-dot { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen">
    <div id="app"></div>

    <script>
        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        const BACKEND_URL = window.location.origin;
        
        let state = {
            corpora: [],
            activeTab: 'input',
            backendStatus: 'checking',
            processing: false,
            processingStatus: '',
            textInput: '',
            corpusName: '',
            posSearchTerm: '',
            semanticSearchTerm: '',
            contextSize: 5,
            selectedCorpora: [],
            showSplitDialog: false,
            selectedCorpusForSplit: null,
            splitRanges: [{ name: '', startPage: 1, endPage: 1 }]
        };

        // Check backend health
        async function checkBackendHealth() {
            try {
                const response = await fetch(`${BACKEND_URL}/health`);
                if (response.ok) {
                    state.backendStatus = 'connected';
                } else {
                    state.backendStatus = 'error';
                }
            } catch (error) {
                state.backendStatus = 'disconnected';
            }
            render();
        }

        // Process text with backend
        async function processText(text, name) {
            const response = await fetch(`${BACKEND_URL}/analyze`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, corpus_name: name })
            });

            if (!response.ok) {
                const error = await response.json().catch(() => ({}));
                throw new Error(error.error || `Backend error: ${response.status}`);
            }

            const data = await response.json();
            return data.tokens;
        }

        // Extract text from PDF
        async function extractPDFText(file) {
            state.processingStatus = 'Loading PDF...';
            render();

            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            const numPages = pdf.numPages;

            state.processingStatus = `Extracting text from ${numPages} pages...`;
            render();

            const textPromises = [];
            for (let i = 1; i <= numPages; i++) {
                textPromises.push(
                    pdf.getPage(i)
                        .then(page => page.getTextContent())
                        .then(content => content.items.map(item => item.str).join(' '))
                );
            }

            const pageTexts = await Promise.all(textPromises);
            return {
                text: pageTexts.join('\n\n'),
                pages: numPages,
                pageTexts
            };
        }

        // Handle file upload
        async function handleFileUpload(event) {
            const files = event.target.files;
            if (!files.length) return;

            if (state.backendStatus !== 'connected') {
                alert('Backend is not connected!');
                return;
            }

            state.processing = true;
            render();

            for (const file of files) {
                try {
                    let text = '';
                    let pages = 1;
                    let pageTexts = [];

                    if (file.type === 'application/pdf') {
                        const pdfData = await extractPDFText(file);
                        text = pdfData.text;
                        pages = pdfData.pages;
                        pageTexts = pdfData.pageTexts;
                    } else {
                        text = await file.text();
                    }

                    if (!text.trim()) {
                        alert(`Could not extract text from ${file.name}`);
                        continue;
                    }

                    state.processingStatus = `Analyzing ${file.name} with spaCy + PyMUSAS...`;
                    render();

                    const tagged = await processText(text, file.name);

                    state.corpora.push({
                        id: Date.now() + Math.random(),
                        name: file.name,
                        text,
                        tagged,
                        type: file.type === 'application/pdf' ? 'pdf' : 'text',
                        pages,
                        pageTexts
                    });

                    state.processingStatus = `‚úì ${file.name} analyzed successfully!`;
                } catch (error) {
                    alert(`Error processing ${file.name}: ${error.message}`);
                }
            }

            state.processing = false;
            state.processingStatus = '';
            event.target.value = '';
            render();
        }

        // Analyze text input
        async function analyzeText() {
            if (!state.textInput.trim()) {
                alert('Please enter some text first');
                return;
            }

            if (state.backendStatus !== 'connected') {
                alert('Backend is not connected!');
                return;
            }

            state.processing = true;
            render();

            try {
                const name = state.corpusName.trim() || `Text_${Date.now()}`;
                
                state.processingStatus = `Analyzing with real spaCy + PyMUSAS...`;
                render();
                
                const tagged = await processText(state.textInput, name);

                state.corpora.push({
                    id: Date.now(),
                    name,
                    text: state.textInput,
                    tagged,
                    type: 'text',
                    pages: 1
                });

                state.textInput = '';
                state.corpusName = '';
                state.activeTab = 'pos';
                alert(`Success! Analyzed ${tagged.length} tokens.`);
            } catch (error) {
                alert(`Error: ${error.message}`);
            }

            state.processing = false;
            state.processingStatus = '';
            render();
        }

        // Split corpus
        async function splitCorpus() {
            if (!state.selectedCorpusForSplit) return;

            state.processing = true;
            state.showSplitDialog = false;
            render();

            const corpus = state.selectedCorpusForSplit;

            for (const range of state.splitRanges) {
                try {
                    const startIdx = range.startPage - 1;
                    const endIdx = range.endPage;
                    
                    let subText = '';
                    if (corpus.pageTexts && corpus.pageTexts.length > 0) {
                        subText = corpus.pageTexts.slice(startIdx, endIdx).join('\n\n');
                    } else {
                        const charsPerPage = Math.ceil(corpus.text.length / corpus.pages);
                        const startChar = startIdx * charsPerPage;
                        const endChar = endIdx * charsPerPage;
                        subText = corpus.text.substring(startChar, endChar);
                    }

                    if (!subText.trim()) continue;

                    state.processingStatus = `Processing sub-corpus ${range.name}...`;
                    render();

                    const tagged = await processText(subText, range.name);

                    state.corpora.push({
                        id: Date.now() + Math.random(),
                        name: range.name || `${corpus.name} (p${range.startPage}-${range.endPage})`,
                        text: subText,
                        tagged,
                        type: 'subcorpus',
                        parentId: corpus.id,
                        pages: range.endPage - range.startPage + 1
                    });
                } catch (error) {
                    alert(`Error creating sub-corpus: ${error.message}`);
                }
            }

            state.processing = false;
            state.processingStatus = '';
            state.splitRanges = [{ name: '', startPage: 1, endPage: 1 }];
            render();
        }

        // Get POS search results
        function getPosResults() {
            if (!state.posSearchTerm) return [];

            const results = [];
            const searchCorpora = state.selectedCorpora.length > 0 
                ? state.corpora.filter(c => state.selectedCorpora.includes(c.id))
                : state.corpora;

            searchCorpora.forEach(corpus => {
                if (!corpus.tagged) return;

                corpus.tagged.forEach((token, idx) => {
                    // Match both POS and TAG
                    const searchUpper = state.posSearchTerm.toUpperCase();
                    if (token.pos && token.pos.toUpperCase().includes(searchUpper) ||
                        token.tag && token.tag.toUpperCase().includes(searchUpper)) {
                        const left = corpus.tagged
                            .slice(Math.max(0, idx - state.contextSize), idx)
                            .map(t => t.word).join(' ');
                        const right = corpus.tagged
                            .slice(idx + 1, Math.min(corpus.tagged.length, idx + state.contextSize + 1))
                            .map(t => t.word).join(' ');

                        results.push({
                            corpusName: corpus.name,
                            left,
                            node: token.word,
                            right,
                            pos: token.pos,
                            tag: token.tag
                        });
                    }
                });
            });

            return results;
        }

        // Get semantic search results
        function getSemanticResults() {
            if (!state.semanticSearchTerm) return [];

            const results = [];
            const searchCorpora = state.selectedCorpora.length > 0 
                ? state.corpora.filter(c => state.selectedCorpora.includes(c.id))
                : state.corpora;

            searchCorpora.forEach(corpus => {
                if (!corpus.tagged) return;

                corpus.tagged.forEach((token, idx) => {
                    if (token.semantic && token.semantic.toLowerCase().includes(state.semanticSearchTerm.toLowerCase())) {
                        const left = corpus.tagged
                            .slice(Math.max(0, idx - state.contextSize), idx)
                            .map(t => t.word).join(' ');
                        const right = corpus.tagged
                            .slice(idx + 1, Math.min(corpus.tagged.length, idx + state.contextSize + 1))
                            .map(t => t.word).join(' ');

                        results.push({
                            corpusName: corpus.name,
                            left,
                            node: token.word,
                            right,
                            semantic: token.semantic
                        });
                    }
                });
            });

            return results;
        }

        // Generate dependency tree SVG
        function generateDependencyTree() {
            const allTagged = state.corpora.flatMap(c => c.tagged || []).filter(t => t.dep);
            if (allTagged.length === 0) return '<p class="text-gray-500 text-center py-12">No data to display</p>';

            const displayWords = allTagged.slice(0, 30);
            const width = Math.max(1000, displayWords.length * 70);
            const height = 400;
            const wordSpacing = width / (displayWords.length + 1);
            const baseY = 280;

            let svg = `<svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}" class="border-2 border-indigo-100 rounded-lg bg-white">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <polygon points="0 0, 10 3, 0 6" fill="#6366f1" />
                    </marker>
                </defs>`;

            displayWords.forEach((item, idx) => {
                const x = (idx + 1) * wordSpacing;
                const headIdx = Math.min(Math.max(0, item.head || 0), displayWords.length - 1);
                const headX = (headIdx + 1) * wordSpacing;

                if (item.dep !== 'ROOT' && headIdx !== idx) {
                    const arcHeight = Math.abs(idx - headIdx) * 20 + 30;
                    const midX = (x + headX) / 2;
                    const midY = baseY - arcHeight;

                    svg += `<path d="M ${x} ${baseY - 20} Q ${midX} ${midY} ${headX} ${baseY - 20}" 
                        stroke="#6366f1" stroke-width="2" fill="none" marker-end="url(#arrowhead)" opacity="0.7"/>
                        <text x="${midX}" y="${midY - 5}" text-anchor="middle" class="text-xs fill-indigo-600 font-semibold">${item.dep}</text>`;
                }

                const displayWord = item.word.length > 12 ? item.word.substring(0, 12) + '..' : item.word;
                svg += `<text x="${x}" y="${baseY}" text-anchor="middle" class="text-sm font-bold fill-gray-800">${displayWord}</text>
                    <text x="${x}" y="${baseY + 18}" text-anchor="middle" class="text-xs fill-purple-600">${item.pos}</text>`;
            });

            svg += '</svg>';
            return svg;
        }

        // Generate collocation network
        function generateCollocationNetwork() {
            const allWords = state.corpora.flatMap(c => (c.tagged || []).map(t => t.word.toLowerCase()));
            if (allWords.length < 2) return '<p class="text-gray-500 text-center py-12">Need more data</p>';

            const bigrams = {};
            for (let i = 0; i < allWords.length - 1; i++) {
                const bigram = `${allWords[i]}|${allWords[i + 1]}`;
                bigrams[bigram] = (bigrams[bigram] || 0) + 1;
            }

            const topBigrams = Object.entries(bigrams)
                .filter(([_, count]) => count > 1)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15);

            if (topBigrams.length === 0) {
                return '<p class="text-gray-500 text-center py-12">No repeated word pairs found</p>';
            }

            const width = 700;
            const height = 500;
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = 180;

            const uniqueWords = [...new Set(topBigrams.flatMap(([bigram]) => bigram.split('|')))];

            let svg = `<svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}" class="border-2 border-purple-100 rounded-lg bg-white">`;

            topBigrams.forEach(([bigram, count]) => {
                const [word1, word2] = bigram.split('|');
                const idx1 = uniqueWords.indexOf(word1);
                const idx2 = uniqueWords.indexOf(word2);

                const angle1 = (idx1 / uniqueWords.length) * 2 * Math.PI - Math.PI / 2;
                const angle2 = (idx2 / uniqueWords.length) * 2 * Math.PI - Math.PI / 2;

                const x1 = centerX + radius * Math.cos(angle1);
                const y1 = centerY + radius * Math.sin(angle1);
                const x2 = centerX + radius * Math.cos(angle2);
                const y2 = centerY + radius * Math.sin(angle2);

                svg += `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" 
                    stroke="#a855f7" stroke-width="${Math.min(count * 2, 8)}" opacity="0.5"/>`;
            });

            uniqueWords.forEach((word, idx) => {
                const angle = (idx / uniqueWords.length) * 2 * Math.PI - Math.PI / 2;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);

                const displayWord = word.length > 8 ? word.substring(0, 7) + '..' : word;
                svg += `<circle cx="${x}" cy="${y}" r="30" fill="#8b5cf6" opacity="0.9" stroke="#6d28d9" stroke-width="2"/>
                    <text x="${x}" y="${y + 5}" text-anchor="middle" class="text-sm font-bold fill-white">${displayWord}</text>`;
            });

            svg += '</svg>';
            return svg;
        }

        // Export to CSV
        function exportToCSV(data, filename) {
            if (!data || data.length === 0) return;

            const headers = Object.keys(data[0]);
            const csv = [
                headers.join(','),
                ...data.map(row => headers.map(h => `"${(row[h] || '').toString().replace(/"/g, '""')}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Render app
        function render() {
            const app = document.getElementById('app');
            const posResults = getPosResults();
            const semanticResults = getSemanticResults();

            app.innerHTML = `
                ${state.showSplitDialog ? renderSplitDialog() : ''}
                
                <!-- Header -->
                <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 text-white p-6 shadow-xl">
                    <div class="max-w-7xl mx-auto flex items-center justify-between flex-wrap gap-4">
                        <div>
                            <h1 class="text-3xl font-bold mb-2">‚ö° CorBas</h1>
                            <p class="text-indigo-100 text-sm">University of Basra ‚Ä¢ Linguistics</p>
                            <p class="text-indigo-200 text-xs mt-1">Real PyMUSAS & spaCy</p>
                        </div>
                        <div class="text-right">
                            <div class="inline-flex items-center gap-2 px-4 py-2 rounded-lg ${
                                state.backendStatus === 'connected' ? 'bg-green-500' :
                                state.backendStatus === 'checking' ? 'bg-yellow-500' : 'bg-red-500'
                            }">
                                <div class="w-2 h-2 rounded-full bg-white ${state.backendStatus === 'connected' ? 'status-dot' : ''}"></div>
                                <span class="text-sm font-semibold">
                                    ${state.backendStatus === 'connected' ? 'Connected' :
                                      state.backendStatus === 'checking' ? 'Checking...' : 'Offline'}
                                </span>
                            </div>
                            ${state.backendStatus !== 'connected' ? `
                                <button onclick="checkBackendHealth()" class="text-xs text-white underline mt-1">Retry</button>
                            ` : ''}
                        </div>
                    </div>
                </div>

                ${state.processing ? `
                    <div class="bg-yellow-100 border-b-2 border-yellow-300 p-3 text-center">
                        <span class="text-yellow-900 font-semibold">‚è≥ ${state.processingStatus || 'Processing...'}</span>
                    </div>
                ` : ''}

                <!-- Tabs -->
                <div class="bg-white shadow-md overflow-x-auto">
                    <div class="max-w-7xl mx-auto flex">
                        ${renderTab('input', 'üìù Input')}
                        ${renderTab('pos', 'üè∑Ô∏è POS')}
                        ${renderTab('semantic', 'üî¢ Semantic')}
                        ${renderTab('dependency', 'üå≥ Dependencies')}
                        ${renderTab('collocation', 'üîó Collocations')}
                    </div>
                </div>

                <!-- Content -->
                <div class="max-w-7xl mx-auto p-4">
                    ${state.activeTab === 'input' ? renderInputTab() :
                      state.activeTab === 'pos' ? renderPosTab(posResults) :
                      state.activeTab === 'semantic' ? renderSemanticTab(semanticResults) :
                      state.activeTab === 'dependency' ? renderDependencyTab() :
                      renderCollocationTab()}
                </div>

                <!-- Footer -->
                <div class="text-center py-6 text-gray-600 text-sm border-t">
                    <p class="font-semibold">CorBas v2.0 Complete</p>
                </div>
            `;
        }

        function renderTab(id, label) {
            return `<button onclick="state.activeTab='${id}'; render();" 
                class="px-6 py-4 font-medium transition-all whitespace-nowrap ${
                    state.activeTab === id 
                        ? 'bg-indigo-600 text-white border-b-4 border-indigo-700' 
                        : 'text-gray-600 hover:bg-gray-50'
                }">${label}</button>`;
        }

        function renderInputTab() {
            return `
                <div class="space-y-4">
                    <!-- Text Input -->
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h2 class="text-2xl font-bold mb-4">üìù Enter Text</h2>
                        <div class="space-y-4">
                            <input type="text" value="${state.corpusName}" oninput="state.corpusName=this.value"
                                placeholder="Corpus name (optional)" class="w-full p-3 border-2 rounded-xl" ${state.processing ? 'disabled' : ''}>
                            <textarea oninput="state.textInput=this.value" placeholder="Paste text here..." 
                                class="w-full h-40 p-4 border-2 rounded-xl resize-none" ${state.processing ? 'disabled' : ''}>${state.textInput}</textarea>
                            <button onclick="analyzeText()" ${state.processing || !state.textInput.trim() ? 'disabled' : ''}
                                class="w-full bg-indigo-600 text-white py-3 rounded-xl font-semibold hover:bg-indigo-700 disabled:opacity-50">
                                ‚ö° Analyze Text
                            </button>
                        </div>
                    </div>

                    <!-- File Upload -->
                    <div class="bg-white rounded-2xl shadow-xl p-6">
                        <h2 class="text-2xl font-bold mb-4">üìÑ Upload Files</h2>
                        <label class="block">
                            <span class="sr-only">Choose files</span>
                            <input type="file" multiple accept=".txt,.pdf" onchange="handleFileUpload(event)" 
                                class="block w-full text-sm text-gray-500 file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700 cursor-pointer"
                                ${state.processing ? 'disabled' : ''}>
                        </label>
                    </div>

                    <!-- Corpora List -->
                    ${state.corpora.length > 0 ? `
                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            <h2 class="text-2xl font-bold mb-4">üìö Your Corpora (${state.corpora.length})</h2>
                            <div class="space-y-2">
                                ${state.corpora.map(c => `
                                    <div class="flex items-center justify-between p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border border-indigo-200">
                                        <div>
                                            <p class="font-semibold text-gray-800">${c.name}</p>
                                            <p class="text-sm text-gray-600">${c.tagged.length} tokens ‚Ä¢ ${c.type} ${c.pages > 1 ? `‚Ä¢ ${c.pages} pages` : ''}</p>
                                        </div>
                                        ${c.type === 'pdf' && c.pages > 1 ? `
                                            <button onclick="state.selectedCorpusForSplit=${JSON.stringify(c).replace(/"/g, '&quot;')}; state.showSplitDialog=true; render();"
                                                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-sm font-semibold">
                                                ‚úÇÔ∏è Split
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderPosTab(results) {
            return `
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold mb-4">üè∑Ô∏è POS Tag Search</h2>
                    <div class="space-y-4 mb-6">
                        <input type="text" value="${state.posSearchTerm}" oninput="state.posSearchTerm=this.value; render();"
                            placeholder="e.g., NOUN, VERB, ADJ, NNP, VBD..." class="w-full p-3 border-2 rounded-xl">
                        <div class="flex items-center gap-4">
                            <label class="text-sm font-semibold">Context: ${state.contextSize}</label>
                            <input type="range" min="2" max="15" value="${state.contextSize}" 
                                oninput="state.contextSize=parseInt(this.value); render();" class="flex-1">
                        </div>
                    </div>

                    ${results.length === 0 ? `
                        <p class="text-gray-500 text-center py-12">${state.posSearchTerm ? 'No matches' : 'Enter POS tag'}</p>
                    ` : `
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-4 bg-indigo-50 rounded-xl">
                                <p class="font-semibold">${results.length} results</p>
                                <button onclick='exportToCSV(${JSON.stringify(results.map((r, i) => ({Number: i+1, ...r})))}, "pos_results")'
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">üíæ Export</button>
                            </div>
                            <div class="overflow-x-auto border-2 rounded-xl">
                                <table class="w-full">
                                    <thead class="bg-indigo-100">
                                        <tr>
                                            <th class="p-3 text-left font-bold">No.</th>
                                            <th class="p-3 text-left font-bold">Corpus</th>
                                            <th class="p-3 text-left font-bold">Left</th>
                                            <th class="p-3 text-center font-bold">Node</th>
                                            <th class="p-3 text-left font-bold">Right</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${results.map((r, i) => `
                                            <tr class="border-b hover:bg-indigo-50">
                                                <td class="p-3">${i + 1}</td>
                                                <td class="p-3 text-sm">${r.corpusName}</td>
                                                <td class="p-3 text-sm text-right text-gray-600">${r.left}</td>
                                                <td class="p-3 text-center">
                                                    <span class="font-bold text-indigo-700 bg-indigo-100 px-3 py-1 rounded">${r.node}</span>
                                                    <div class="text-xs text-gray-500 mt-1">${r.pos} / ${r.tag}</div>
                                                </td>
                                                <td class="p-3 text-sm text-gray-600">${r.right}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function renderSemanticTab(results) {
            return `
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold mb-4">üî¢ Semantic Tag Search (PyMUSAS)</h2>
                    <div class="space-y-4 mb-6">
                        <input type="text" value="${state.semanticSearchTerm}" oninput="state.semanticSearchTerm=this.value; render();"
                            placeholder="e.g., S1.2, A5.1+, M1, E1..." class="w-full p-3 border-2 rounded-xl">
                        <div class="p-3 bg-green-50 rounded-xl border border-green-200">
                            <p class="text-sm font-semibold text-green-900">‚úÖ Real PyMUSAS USAS Tags</p>
                        </div>
                    </div>

                    ${results.length === 0 ? `
                        <p class="text-gray-500 text-center py-12">${state.semanticSearchTerm ? 'No matches' : 'Enter semantic tag'}</p>
                    ` : `
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-4 bg-purple-50 rounded-xl">
                                <p class="font-semibold">${results.length} results</p>
                                <button onclick='exportToCSV(${JSON.stringify(results.map((r, i) => ({Number: i+1, ...r})))}, "semantic_results")'
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">üíæ Export</button>
                            </div>
                            <div class="overflow-x-auto border-2 rounded-xl">
                                <table class="w-full">
                                    <thead class="bg-purple-100">
                                        <tr>
                                            <th class="p-3 text-left font-bold">No.</th>
                                            <th class="p-3 text-left font-bold">Corpus</th>
                                            <th class="p-3 text-left font-bold">Left</th>
                                            <th class="p-3 text-center font-bold">Node</th>
                                            <th class="p-3 text-left font-bold">Right</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${results.map((r, i) => `
                                            <tr class="border-b hover:bg-purple-50">
                                                <td class="p-3">${i + 1}</td>
                                                <td class="p-3 text-sm">${r.corpusName}</td>
                                                <td class="p-3 text-sm text-right text-gray-600">${r.left}</td>
                                                <td class="p-3 text-center">
                                                    <span class="font-bold text-purple-700 bg-purple-100 px-3 py-1 rounded">${r.node}</span>
                                                    <div class="text-xs text-gray-500 mt-1">${r.semantic}</div>
                                                </td>
                                                <td class="p-3 text-sm text-gray-600">${r.right}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function renderDependencyTab() {
            return `
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold mb-6">üå≥ Dependency Trees (spaCy)</h2>
                    ${state.corpora.length === 0 ? `
                        <p class="text-gray-500 text-center py-12">Upload a corpus to view dependency trees</p>
                    ` : `
                        <div class="space-y-6">
                            <p class="text-sm text-gray-600 bg-indigo-50 p-4 rounded-lg">
                                Showing syntactic dependencies from spaCy parser. Arrows show grammatical relationships.
                            </p>
                            <div class="overflow-x-auto">
                                ${generateDependencyTree()}
                            </div>
                            <div class="p-4 bg-indigo-50 rounded-xl">
                                <p class="text-sm font-semibold text-indigo-900 mb-2">Common Dependencies:</p>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs text-indigo-800">
                                    <div>‚Ä¢ <b>ROOT:</b> Main verb</div>
                                    <div>‚Ä¢ <b>nsubj:</b> Subject</div>
                                    <div>‚Ä¢ <b>det:</b> Determiner</div>
                                    <div>‚Ä¢ <b>amod:</b> Adj modifier</div>
                                    <div>‚Ä¢ <b>prep:</b> Preposition</div>
                                    <div>‚Ä¢ <b>pobj:</b> Prep object</div>
                                    <div>‚Ä¢ <b>dobj:</b> Direct object</div>
                                    <div>‚Ä¢ <b>aux:</b> Auxiliary</div>
                                </div>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function renderCollocationTab() {
            return `
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h2 class="text-2xl font-bold mb-6">üîó Collocation Network</h2>
                    ${state.corpora.length === 0 ? `
                        <p class="text-gray-500 text-center py-12">Upload a corpus to view collocations</p>
                    ` : `
                        <div class="space-y-6">
                            <p class="text-sm text-gray-600 bg-purple-50 p-4 rounded-lg">
                                Network showing frequent word pairs (bigrams). Line thickness = frequency.
                            </p>
                            <div class="flex justify-center">
                                ${generateCollocationNetwork()}
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function renderSplitDialog() {
            const corpus = state.selectedCorpusForSplit;
            if (!corpus) return '';

            return `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this){state.showSplitDialog=false; render();}">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation();">
                        <div class="p-6 border-b bg-indigo-50">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-2xl font-bold">‚úÇÔ∏è Split Corpus</h3>
                                    <p class="text-sm text-gray-600 mt-1">${corpus.name} (${corpus.pages} pages)</p>
                                </div>
                                <button onclick="state.showSplitDialog=false; render();" class="text-gray-500 hover:text-gray-700">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="p-6 space-y-4">
                            ${state.splitRanges.map((range, idx) => `
                                <div class="p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl border-2 border-indigo-200">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="font-semibold">Sub-corpus ${idx + 1}</h4>
                                        ${state.splitRanges.length > 1 ? `
                                            <button onclick="state.splitRanges.splice(${idx}, 1); render();" class="text-red-600 hover:text-red-700">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                </svg>
                                            </button>
                                        ` : ''}
                                    </div>
                                    <input type="text" value="${range.name}" 
                                        oninput="state.splitRanges[${idx}].name=this.value; render();"
                                        placeholder="Sub-corpus name" class="w-full p-2 border-2 rounded-lg mb-3">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-sm font-semibold mb-1">Start Page</label>
                                            <input type="number" min="1" max="${corpus.pages}" value="${range.startPage}"
                                                oninput="state.splitRanges[${idx}].startPage=parseInt(this.value)||1; render();"
                                                class="w-full p-2 border-2 rounded-lg">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold mb-1">End Page</label>
                                            <input type="number" min="1" max="${corpus.pages}" value="${range.endPage}"
                                                oninput="state.splitRanges[${idx}].endPage=parseInt(this.value)||1; render();"
                                                class="w-full p-2 border-2 rounded-lg">
                                        </div>
                                    </div>
                                </div>
                            `).join('')}

                            <button onclick="state.splitRanges.push({name:'', startPage:1, endPage:1}); render();"
                                class="w-full p-3 border-2 border-dashed border-indigo-300 text-indigo-600 rounded-xl hover:bg-indigo-50 font-semibold">
                                + Add Another Range
                            </button>
                        </div>

                        <div class="p-6 border-t bg-gray-50 flex gap-3">
                            <button onclick="state.showSplitDialog=false; render();" 
                                class="flex-1 px-6 py-3 border-2 border-gray-300 rounded-xl hover:bg-gray-100 font-semibold">
                                Cancel
                            </button>
                            <button onclick="splitCorpus();" 
                                class="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl hover:from-indigo-700 hover:to-purple-700 font-semibold shadow-lg">
                                Create Sub-corpora
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize
        checkBackendHealth();
        setInterval(checkBackendHealth, 5000);
        render();
    </script>
</body>

</html>
